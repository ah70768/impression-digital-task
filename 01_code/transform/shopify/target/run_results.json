{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.9.1", "generated_at": "2024-12-23T03:18:14.922927Z", "invocation_id": "e61e7e02-816f-429f-9f44-2dada926af44", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2024-12-23T03:17:57.917999Z", "completed_at": "2024-12-23T03:17:57.961671Z"}, {"name": "execute", "started_at": "2024-12-23T03:17:57.962626Z", "completed_at": "2024-12-23T03:18:02.326860Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 4.4141271114349365, "adapter_response": {"_message": "CREATE TABLE (47.0 rows, 119.6 KiB processed)", "code": "CREATE TABLE", "rows_affected": 47, "bytes_processed": 122460, "bytes_billed": 10485760, "location": "EU", "project_id": "impression-digital", "job_id": "79d5b898-7953-4162-b709-381218d1a2ad", "slot_ms": 3876}, "message": "CREATE TABLE (47.0 rows, 119.6 KiB processed)", "failures": null, "unique_id": "model.shopify.product", "compiled": true, "compiled_code": "\n\nWITH stage_product AS\n(\nSELECT \n  id\n  ,title\n  ,body_html\n  ,vendor\n  ,product_type\n  ,PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S%Ez', created_at) AS created_at\n  ,handle\n  ,PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S%Ez', updated_at) AS updated_at\n  ,PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S%Ez', published_at) AS published_at\n  ,template_suffix\n  ,published_scope\n  ,tags\n  ,status\n  ,admin_graphql_api_id\n  ,variants\n  ,options\n  ,images\n  ,image\nFROM raw.product\n)\n\nSELECT * FROM stage_product", "relation_name": "`impression-digital`.`staging`.`product`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-12-23T03:18:02.344077Z", "completed_at": "2024-12-23T03:18:02.501135Z"}, {"name": "execute", "started_at": "2024-12-23T03:18:02.503626Z", "completed_at": "2024-12-23T03:18:06.803572Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 4.462287187576294, "adapter_response": {"_message": "CREATE TABLE (30.0 rows, 34.7 KiB processed)", "code": "CREATE TABLE", "rows_affected": 30, "bytes_processed": 35488, "bytes_billed": 20971520, "location": "EU", "project_id": "impression-digital", "job_id": "21c5d246-fc4b-4919-9949-dce0a930378a", "slot_ms": 18086}, "message": "CREATE TABLE (30.0 rows, 34.7 KiB processed)", "failures": null, "unique_id": "model.shopify.order", "compiled": true, "compiled_code": "\n\n\nWITH correct_prices AS \n(\n    SELECT\n        od.order_number\n        ,line.product_id\n        ,CAST(variant.price AS NUMERIC) AS price\n        ,CAST(line.quantity AS NUMERIC) AS quantity\n        ,CAST(variant.price AS NUMERIC)*CAST(line.quantity AS NUMERIC) AS subtotal\n    FROM raw.order AS od\n    LEFT JOIN UNNEST(od.line_items) AS line\n    LEFT JOIN `impression-digital`.`staging`.`product` AS pd\n        ON line.product_id = pd.id\n    LEFT JOIN UNNEST(pd.variants) AS variant\n        ON line.variant_id = variant.id\n)\n\n,shipping_price AS\n(\n    SELECT \n        order_number\n        ,CAST(ship.price AS NUMERIC) AS price\n    FROM raw.order,\n    UNNEST(shipping_lines) AS ship \n)\n\n,subtotals AS\n(\nSELECT \n  order_number\n  ,SUM(subtotal) AS subtotal\nFROM correct_prices\nGROUP BY order_number\n)\n\n,stage_order AS\n(\nSELECT \n  o.order_number\n  ,PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S%Ez', created_at) AS created_at\n  ,phone\n  ,contact_email\n  ,po_number\n  ,COALESCE(s.subtotal, CAST(o.current_subtotal_price AS NUMERIC)) AS subtotal\n  ,CAST(total_discounts AS NUMERIC) AS total_discounts\n  ,COALESCE(s.subtotal, CAST(o.current_subtotal_price AS NUMERIC)) - CAST(o.total_discounts AS NUMERIC) AS current_subtotal_price\n  ,IFNULL(sp.price,0) AS shipping_cost\n  ,COALESCE(s.subtotal, CAST(o.current_subtotal_price AS NUMERIC)) - CAST(o.total_discounts AS NUMERIC) + IFNULL(sp.price,0) AS total_price \n  -- ,CAST(o.current_subtotal_price AS NUMERIC) AS shopify_total\n  -- ,o.total_price\n  ,CAST(total_tax AS NUMERIC) AS total_tax\n  ,financial_status\n  ,fulfillment_status\n  ,note\n  ,customer\n  ,line_items\n  ,refunds\n  ,shipping_address\nFROM\n  raw.order AS o\nLEFT JOIN shipping_price AS sp\n  ON o.order_number = sp.order_number\nLEFT JOIN subtotals AS s\n  ON s.order_number = o.order_number\n\n\n-- ORDER BY o.order_number\n)\n\n\nSELECT *\nFROM stage_order", "relation_name": "`impression-digital`.`staging`.`order`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-12-23T03:18:06.825996Z", "completed_at": "2024-12-23T03:18:06.833483Z"}, {"name": "execute", "started_at": "2024-12-23T03:18:06.843931Z", "completed_at": "2024-12-23T03:18:11.003475Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 4.17747950553894, "adapter_response": {"_message": "CREATE TABLE (13.0 rows, 7.5 KiB processed)", "code": "CREATE TABLE", "rows_affected": 13, "bytes_processed": 7717, "bytes_billed": 20971520, "location": "EU", "project_id": "impression-digital", "job_id": "105b4418-d1b1-43e8-ba1f-06a694af08b0", "slot_ms": 13496}, "message": "CREATE TABLE (13.0 rows, 7.5 KiB processed)", "failures": null, "unique_id": "model.shopify.customer", "compiled": true, "compiled_code": "\n\nWITH cust_spend AS\n(\n  SELECT\n    customer.id\n    ,SUM(current_subtotal_price) AS subtotal_spent\n    ,SUM(total_price) AS total_spent\n  FROM `impression-digital`.`staging`.`order`\n  GROUP BY customer.id\n)\n\n,stage_cust AS\n(\n  SELECT\n    c.id\n    ,email\n    ,PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S%Ez', created_at) AS created_at\n    ,PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S%Ez', updated_at) AS updated_at\n    ,first_name\n    ,last_name\n    ,CAST(orders_count AS INT64) AS orders_count\n    ,state\n    -- ,s.total_spent\n    ,COALESCE(s.total_spent, CAST(c.total_spent AS FLOAT64), 0) AS total_spent\n    ,CAST(last_order_id AS STRING) AS last_order_id\n    ,note\n    ,CAST(verified_email AS BOOL) AS verified_email\n    ,multipass_identifier\n    ,CAST(tax_exempt AS BOOL) AS tax_exempt\n    ,tags\n    ,last_order_name\n    ,currency\n    ,phone\n    ,addresses\n    ,tax_exemptions\n    ,email_marketing_consent\n    ,sms_marketing_consent\n    ,admin_graphql_api_id\n    ,default_address\n  FROM\n    raw.customer AS c\n  LEFT JOIN cust_spend AS s\n  ON c.id = s.id\n)\n\nSELECT * FROM stage_cust", "relation_name": "`impression-digital`.`staging`.`customer`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-12-23T03:18:11.029077Z", "completed_at": "2024-12-23T03:18:11.046663Z"}, {"name": "execute", "started_at": "2024-12-23T03:18:11.049562Z", "completed_at": "2024-12-23T03:18:14.874952Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.8513779640197754, "adapter_response": {"_message": "CREATE TABLE (19.0 rows, 4.9 KiB processed)", "code": "CREATE TABLE", "rows_affected": 19, "bytes_processed": 4979, "bytes_billed": 20971520, "location": "EU", "project_id": "impression-digital", "job_id": "200eb593-8b21-445f-88bd-00a45a53820d", "slot_ms": 10229}, "message": "CREATE TABLE (19.0 rows, 4.9 KiB processed)", "failures": null, "unique_id": "model.shopify.product_sales_agg", "compiled": true, "compiled_code": "\n\nWITH all_lines AS (\n\nSELECT \n  od.order_number\n  ,line.product_id AS line_product_id\n  ,line.variant_id AS line_variant_id\n  ,CAST(variant.price AS NUMERIC) AS price\n  ,CAST(line.quantity AS NUMERIC) AS quantity\n  ,IFNULL(CAST(discount.amount AS NUMERIC), 0) AS discount\n  ,od.total_discounts\n  ,od.financial_status AS payment_status\nFROM\n   `impression-digital`.`staging`.`order` AS od\nLEFT JOIN\n  UNNEST(od.line_items) AS line\nLEFT JOIN\n   `impression-digital`.`staging`.`product` AS pd\n  ON line.product_id = pd.id\nLEFT JOIN\n  UNNEST(pd.variants) AS variant\n  ON line.variant_id = variant.id\nLEFT JOIN\n  UNNEST(line.discount_allocations) AS discount\nWHERE od.financial_status IN ('paid') -- only counting sales from paid orders\n)\n\n-- same product within an order can have different discounts applied. Need to group down to variant level and sum discounts\n,discount_summed AS(\n  SELECT\n    order_number\n    ,line_product_id\n    ,line_variant_id\n    ,quantity\n    ,SUM(discount) AS discount\n  FROM all_lines\n  GROUP BY order_number, line_product_id, line_variant_id, quantity\n)\n\n-- add the summed discount back to respective row in all_lines via a join\n,subtotals AS(\nSELECT DISTINCT\n  d.order_number\n  ,d.line_product_id\n  ,d.line_variant_id\n  ,l.price\n  ,d.quantity\n  ,d.discount\n  ,(price*d.quantity) - d.discount AS subtotal\nFROM discount_summed AS d\nLEFT JOIN all_lines AS l\n  ON \n    l.order_number = d.order_number AND\n    l.line_product_id = d.line_product_id AND \n    l.line_variant_id = d.line_variant_id\n)\n\n,agg AS (\n\nSELECT\n  line_product_id AS product_id\n  ,SUM(quantity) AS product_quantity\n  ,SUM(subtotal) AS product_rev\nFROM subtotals\nGROUP BY line_product_id\n)\n\nSELECT * FROM agg\n-- ORDER BY order_number", "relation_name": "`impression-digital`.`processed`.`product_sales_agg`", "batch_results": null}], "elapsed_time": 18.556731462478638, "args": {"require_explicit_package_overrides_for_builtin_materializations": true, "show_resource_report": false, "skip_nodes_if_on_run_start_fails": false, "log_level_file": "debug", "use_colors": true, "version_check": true, "print": true, "indirect_selection": "eager", "write_json": true, "log_path": "C:\\Users\\amarh\\Dropbox\\My_Stuff\\Progress File (Actual)\\Job Applications\\2024\\Data Engineer\\Impression Digital\\impression-digital-task\\01_code\\transform\\shopify\\logs", "select": [], "macro_debugging": false, "printer_width": 80, "send_anonymous_usage_stats": true, "static_parser": true, "cache_selected_only": false, "use_colors_file": true, "log_format_file": "debug", "require_resource_names_without_spaces": false, "partial_parse_file_diff": true, "project_dir": "C:\\Users\\amarh\\Dropbox\\My_Stuff\\Progress File (Actual)\\Job Applications\\2024\\Data Engineer\\Impression Digital\\impression-digital-task\\01_code\\transform\\shopify", "log_file_max_bytes": 10485760, "source_freshness_run_project_hooks": false, "empty": false, "require_batched_execution_for_custom_microbatch_strategy": false, "exclude": [], "warn_error_options": {"include": [], "exclude": []}, "strict_mode": false, "invocation_command": "dbt run", "defer": false, "quiet": false, "profiles_dir": "C:\\Users\\amarh\\.dbt", "state_modified_compare_more_unrendered_values": false, "which": "run", "state_modified_compare_vars": false, "favor_state": false, "introspect": true, "log_level": "info", "populate_cache": true, "require_nested_cumulative_type_params": false, "require_yaml_configuration_for_mf_time_spines": false, "vars": {}, "partial_parse": true, "log_format": "default"}}